<!DOCTYPE html>
<html lang="ko-KR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <script
    type="application/javascript"
    src='https://pink-spider.github.io/js/theme-mode.js'
  ></script>
  <link rel="stylesheet" href='https://pink-spider.github.io/css/frameworks.min.css' />
  <link rel="stylesheet" href='https://pink-spider.github.io/css/github.min.css' />
  <link rel="stylesheet" href='https://pink-spider.github.io/css/github-style.css' />
  <link rel="stylesheet" href='https://pink-spider.github.io/css/light.css' />
  <link rel="stylesheet" href='https://pink-spider.github.io/css/dark.css' />
  <link rel="stylesheet" href='https://pink-spider.github.io/css/syntax.css' />
  
  <link rel="stylesheet" href="/your%20css%20file%20name" />
  
  <title>
    분산락(distributed lock) deep dive | Pink Spider
  </title>
  
  <link rel="icon" type="image/x-icon" href="/images/logo_pinkspider.png" />
  
  <meta name="theme-color" content="#1e2327" />

  
  <meta
  name="description"
  content="분산 시스템에서 여러 대의 서버가 동일한 자원에 동시에 접근할 때, 데이터의 일관성을 유지하기 위해 사용하는 기술이 바로 **분산락(Distributed Lock)**입니다.
단일 서버 환경에서는 synchronized나 ReentrantLock 같은 자바 표준 API로 동시성을 제어할 수 있지만, 서버가 여러 대라면 각 서버의 로컬 락은 서로를 알지 못합니다. 이때 모든 서버가 공통으로 바라보는 외부 저장소를 활용해 &ldquo;누가 자원을 선점했는지&quot;를 기록하는 것이 핵심입니다.
1. 분산락이 필요한 이유 동일한 DB 레코드에 대해 여러 인스턴스가 동시에 수정 요청을 보낼 때, **레이스 컨디션(Race Condition)**이 발생하여 데이터가 꼬일 수 있습니다.
"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://pink-spider.github.io/post/distributed_lock/" />


<meta name="twitter:card" content="summary" />
<meta
  name="twitter:title"
  content="분산락(distributed lock) deep dive - Pink Spider"
/>
<meta
  name="twitter:description"
  content="분산 시스템에서 여러 대의 서버가 동일한 자원에 동시에 접근할 때, 데이터의 일관성을 유지하기 위해 사용하는 기술이 바로 **분산락(Distributed Lock)**입니다.
단일 서버 환경에서는 synchronized나 ReentrantLock 같은 자바 표준 API로 동시성을 제어할 수 있지만, 서버가 여러 대라면 각 서버의 로컬 락은 서로를 알지 못합니다. 이때 모든 서버가 공통으로 바라보는 외부 저장소를 활용해 &ldquo;누가 자원을 선점했는지&quot;를 기록하는 것이 핵심입니다.
1. 분산락이 필요한 이유 동일한 DB 레코드에 대해 여러 인스턴스가 동시에 수정 요청을 보낼 때, **레이스 컨디션(Race Condition)**이 발생하여 데이터가 꼬일 수 있습니다.
"
/>
<meta name="twitter:site" content="https://pink-spider.github.io/" />
<meta name="twitter:creator" content="" />
<meta
  name="twitter:image"
  content="https://pink-spider.github.io/"
/>


<meta
  property="og:type"
  content="article"
/>
<meta
  property="og:title"
  content="분산락(distributed lock) deep dive - Pink Spider"
/>
<meta
  property="og:description"
  content="분산 시스템에서 여러 대의 서버가 동일한 자원에 동시에 접근할 때, 데이터의 일관성을 유지하기 위해 사용하는 기술이 바로 **분산락(Distributed Lock)**입니다.
단일 서버 환경에서는 synchronized나 ReentrantLock 같은 자바 표준 API로 동시성을 제어할 수 있지만, 서버가 여러 대라면 각 서버의 로컬 락은 서로를 알지 못합니다. 이때 모든 서버가 공통으로 바라보는 외부 저장소를 활용해 &ldquo;누가 자원을 선점했는지&quot;를 기록하는 것이 핵심입니다.
1. 분산락이 필요한 이유 동일한 DB 레코드에 대해 여러 인스턴스가 동시에 수정 요청을 보낼 때, **레이스 컨디션(Race Condition)**이 발생하여 데이터가 꼬일 수 있습니다.
"
/>
<meta property="og:url" content="https://pink-spider.github.io/post/distributed_lock/" />
<meta property="og:site_name" content="분산락(distributed lock) deep dive" />
<meta
  property="og:image"
  content="https://pink-spider.github.io/"
/>
<meta property="og:image:width" content="2048" />
<meta property="og:image:height" content="1024" />

<meta property="article:published_time" content="2026-02-13 11:14:05 &#43;0900 KST" />















</head>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6329038356545416"
        crossorigin="anonymous"></script>

<body>
  

<style>
  .height-limitation {
    max-height: 300px;
    overflow-y: scroll;
  }

  .loader {
    border: 4px solid #f3f3f3;
    border-bottom: 4px solid var(--color-fg-muted);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>

<div style="position: relative">
  <header
    class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on"
  >
    <div
      class="Header-item mobile-none"
      style="margin-top: -4px; margin-bottom: -4px"
    >
      <a class="Header-link" href="https://pink-spider.github.io/" aria-label="Home">
        <svg
          class="octicon"
          height="32"
          viewBox="0 0 16 16"
          version="1.1"
          width="32"
        >
          <path
            fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
          ></path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button
        class="Header-link btn-link js-details-target"
        type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'"
        aria-label="Search"
      >
        <svg
          height="24"
          class="octicon octicon-three-bars"
          viewBox="0 0 16 16"
          version="1.1"
          width="24"
        >
          <path
            fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z"
          ></path>
        </svg>
      </button>
    </div>
    <div
      style="display: none"
      id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex"
    >
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to"
      >
        <div class="position-relative">
          <form
            target="_blank"
            action="https://www.google.com/search"
            accept-charset="UTF-8"
            method="get"
            autocomplete="off"
          >
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center"
            >
              <input
                type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q"
                value=""
                placeholder="Search"
                autocomplete="off"
              />
              <input type="hidden" name="q" value="site:https://pink-spider.github.io/" />
              <div
                class="js-jump-to-suggestions-container jump-to-suggestions overflow-hidden position-absolute"
              >
                <div
                  id="search-progress"
                  class="d-none color-bg-primary no-underline p-2"
                  role="progress"
                  aria-selected="false"
                >
                  <div class="loader"></div>
                </div>

                <ul
                  id="jump-to-results"
                  role="listbox"
                  class="Box border-0 p-0 m-0 js-navigation-container jump-to-suggestions-results-container js-jump-to-suggestions-results-container js-active-navigation-container height-limitation"
                ></ul>
              </div>
            </label>
          </form>
        </div>
      </div>
    </div>

    <div
      class="Header-item Header-item--full flex-justify-center d-md-none position-relative"
    >
      <a class="Header-link" href="https://pink-spider.github.io/" aria-label="Home">
        <svg
          class="octicon octicon-mark-github v-align-middle"
          height="32"
          viewBox="0 0 16 16"
          version="1.1"
          width="32"
        >
          <path
            fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
          ></path>
        </svg>
      </a>
    </div>
    <div class="Theme-switcher Header-item" style="margin-right: 0">
      <span
        role="button"
        class="Header-link no-select"
        onclick="switchTheme()"
        style="cursor: pointer"
        aria-label="Switch theme"
      >
        <svg
          style="fill: var(--color-profile-color-modes-toggle-moon)"
          class="no-select"
          viewBox="0 0 16 16"
          version="1.1"
          width="16"
          height="16"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z"
          ></path>
        </svg>
      </span>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://pink-spider.github.io/">
                  <img class=" avatar-user"
                    src="/images/logo_pinkspider.png"
                    width="32" height="32" alt="Pink Spider"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://pink-spider.github.io/">Pink Spider</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://pink-spider.github.io/post/distributed_lock/">분산락(distributed lock) deep dive</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Fri, 13 Feb 2026 11:14:05 &#43;0900"
                    class="no-wrap">
                    Fri, 13 Feb 2026 11:14:05 &#43;0900</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Fri, 13 Feb 2026 11:49:46 &#43;0900"
                    class="no-wrap">
                    Fri, 13 Feb 2026 11:49:46 &#43;0900</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      4148 Words
                    <span class="file-info-divider"></span>
                                        19 min

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>분산 시스템에서 여러 대의 서버가 동일한 자원에 동시에 접근할 때, 데이터의 일관성을 유지하기 위해 사용하는 기술이 바로 **분산락(Distributed Lock)**입니다.</p>
<p>단일 서버 환경에서는 <code>synchronized</code>나 <code>ReentrantLock</code> 같은 자바 표준 API로 동시성을 제어할 수 있지만, 서버가 여러 대라면 각 서버의 로컬 락은 서로를 알지 못합니다. 이때 모든 서버가 공통으로 바라보는 <strong>외부 저장소</strong>를 활용해 &ldquo;누가 자원을 선점했는지&quot;를 기록하는 것이 핵심입니다.</p>
<hr>
<h2 id="1-분산락이-필요한-이유">1. 분산락이 필요한 이유</h2>
<p>동일한 DB 레코드에 대해 여러 인스턴스가 동시에 수정 요청을 보낼 때, **레이스 컨디션(Race Condition)**이 발생하여 데이터가 꼬일 수 있습니다.</p>
<ul>
<li><strong>재고 관리:</strong> 한정판 운동화 재고가 1개인데, 서버 A와 B가 동시에 주문을 처리하면 재고가 -1이 될 수 있습니다.</li>
<li><strong>선착순 이벤트:</strong> 쿠폰 발급 등 정확한 수량 제한이 필요한 경우.</li>
<li><strong>중복 결제 방지:</strong> 동일한 결제 요청이 짧은 시간 내에 두 번 들어올 때 하나만 처리해야 하는 경우.</li>
</ul>
<hr>
<h2 id="2-분산락-구현의-3대장">2. 분산락 구현의 3대장</h2>
<p>보통 인메모리 DB인 <strong>Redis</strong>나 코디네이터 시스템인 <strong>ZooKeeper</strong>를 많이 사용합니다.</p>
<h3 id="1-redis-redisson-라이브러리-방식">1) Redis (Redisson 라이브러리 방식)</h3>
<p>가장 대중적인 방식입니다. 특히 <code>Redisson</code>은 <strong>Pub/Sub</strong> 기능을 활용해 효율적으로 동작합니다.</p>
<ul>
<li><strong>특징:</strong> 락이 해제될 때까지 계속 요청을 보내는(Spin Lock) 대신, 락이 해제되었다는 메시지를 받으면 그때 다시 시도합니다.</li>
<li><strong>장점:</strong> 구현이 쉽고 성능이 매우 빠릅니다.</li>
<li><strong>단점:</strong> Redis 노드가 다운될 경우를 대비해 Redlock 알고리즘 같은 복잡한 설정이 필요할 수 있습니다.</li>
</ul>
<h3 id="2-zookeeper">2) ZooKeeper</h3>
<p>분산 코디네이터인 ZooKeeper의 <strong>Znode</strong>를 활용합니다.</p>
<ul>
<li><strong>특징:</strong> 클라이언트가 세션을 유지하며 락용 노드를 생성합니다. 클라이언트 장애 시 세션이 끊기면 자동으로 락이 해제되어 안전합니다.</li>
<li><strong>장점:</strong> 매우 높은 안정성과 정밀함을 보장합니다.</li>
<li><strong>단점:</strong> Redis에 비해 상대적으로 무겁고 인프라 구축 비용이 큽니다.</li>
</ul>
<h3 id="3-mysql-named-lock">3) MySQL (Named Lock)</h3>
<p>별도의 인프라 없이 기존 DB를 활용하는 방식입니다.</p>
<ul>
<li><strong>특징:</strong> <code>GET_LOCK()</code> 함수를 사용해 문자열 형태의 락을 획득합니다.</li>
<li><strong>장점:</strong> 추가 비용 없이 즉시 적용 가능합니다.</li>
<li><strong>단점:</strong> 커넥션 풀 관리가 까다롭고, 과도한 요청 시 DB 본연의 성능에 영향을 줄 수 있습니다.</li>
</ul>
<hr>
<h2 id="3-구현-시-주의사항-critical-points">3. 구현 시 주의사항 (Critical Points)</h2>
<ul>
<li><strong>타임아웃(Timeout):</strong> 락을 획득한 서버가 갑자기 죽어버리면 락이 영원히 풀리지 않을 수 있습니다. 반드시 **유효 시간(TTL)**을 설정해야 합니다.</li>
<li><strong>원자성(Atomicity):</strong> &ldquo;락이 있는지 확인&quot;하고 &ldquo;락을 획득&quot;하는 과정은 중간에 끊김 없이 한 번에(Atomic) 일어나야 합니다.</li>
<li><strong>락 해제 권한:</strong> 자신이 획득한 락은 반드시 자신만 해제해야 합니다. (A가 가진 락을 B가 풀어버리면 안 됨)</li>
</ul>
<hr>
<h2 id="요약-비교-테이블">요약 비교 테이블</h2>
<table>
  <thead>
      <tr>
          <th>구분</th>
          <th>Redis (Redisson)</th>
          <th>ZooKeeper</th>
          <th>MySQL (Named Lock)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>성능</strong></td>
          <td>매우 빠름</td>
          <td>보통</td>
          <td>상대적으로 느림</td>
      </tr>
      <tr>
          <td><strong>신뢰성</strong></td>
          <td>보통 (데이터 유실 가능성 존재)</td>
          <td>매우 높음</td>
          <td>높음</td>
      </tr>
      <tr>
          <td><strong>난이도</strong></td>
          <td>낮음</td>
          <td>높음</td>
          <td>낮음</td>
      </tr>
      <tr>
          <td><strong>주사용처</strong></td>
          <td>일반적인 서비스 동시성 제어</td>
          <td>금융, 메타데이터 관리 등 고신뢰성</td>
          <td>인프라 추가가 부담스러운 소규모 서비스</td>
      </tr>
  </tbody>
</table>
<h1 id="spring-boot-예시">Spring Boot 예시</h1>
<p>Spring Boot 환경에서 분산락을 구현할 때 가장 많이 사용되는 <strong>Redisson</strong> 라이브러리를 기준으로 설명해 드릴게요.</p>
<p>Redisson은 Redis 기반의 클라이언트지만, 직접 <code>SETNX</code> 명령어를 사용하는 Lettuce와 달리 <strong>Pub/Sub 방식</strong>을 사용하여 Redis에 가해지는 부하를 줄이고, <strong>Lock 자동 갱신(Watchdog)</strong> 기능을 제공해 안정성이 높습니다.</p>
<hr>
<h2 id="1-프로젝트-설정-buildgradle">1. 프로젝트 설정 (<code>build.gradle</code>)</h2>
<p>가장 먼저 Redisson Spring Boot Starter 의존성을 추가합니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gradle" data-lang="gradle"><span class="line"><span class="cl"><span class="n">dependencies</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Redisson Spring Boot Starter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">implementation</span> <span class="s1">&#39;org.redisson:redisson-spring-boot-starter:3.27.0&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><hr>
<h2 id="2-redisson-설정-클래스-redissonconfig">2. Redisson 설정 클래스 (<code>RedissonConfig</code>)</h2>
<p>Redis 서버와의 연결 정보를 설정합니다. (기본값인 <code>localhost:6379</code>를 사용한다면 생략 가능하지만, 실무에서는 보통 커스텀 설정을 합니다.)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RedissonConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&#34;${spring.data.redis.host:127.0.0.1}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">redisHost</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&#34;${spring.data.redis.port:6379}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">redisPort</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="nf">redissonClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Config</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Config</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="na">useSingleServer</span><span class="p">().</span><span class="na">setAddress</span><span class="p">(</span><span class="s">&#34;redis://&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">redisHost</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">redisPort</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Redisson</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">config</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="3-서비스-계층에서의-사용-예시">3. 서비스 계층에서의 사용 예시</h2>
<p>가장 일반적인 <strong>try-finally</strong> 패턴을 사용한 방식입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RequiredArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InventoryService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">InventoryRepository</span><span class="w"> </span><span class="n">inventoryRepository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">decreaseStock</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. 락의 키 이름을 지정 (예: 상품 ID별로 락을 검)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="s">&#34;PRODUCT_LOCK:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">productId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 2. 락 획득 시도 (waitTime: 락을 기다리는 시간, leaseTime: 점유 시간)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">available</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;락 획득 실패&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 3. 비즈니스 로직 수행 (예: 재고 감소)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Inventory</span><span class="w"> </span><span class="n">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inventoryRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">productId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">inventory</span><span class="p">.</span><span class="na">decrease</span><span class="p">(</span><span class="n">quantity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">inventoryRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">inventory</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 4. 반드시 락을 해제 (본인이 획득한 락인지 확인 권장)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="4-핵심-체크포인트-spring-boot-연동-시">4. 핵심 체크포인트 (Spring Boot 연동 시)</h2>
<ol>
<li><strong>트랜잭션 시점 주의 (<code>@Transactional</code>)</strong>:
가장 흔히 하는 실수입니다. <code>@Transactional</code> 안에서 락을 획득하고 해제하면, <strong>락이 해제된 후 트랜잭션 커밋이 일어나기 전</strong>의 찰나에 다른 서버가 락을 획득하여 동시성 문제가 생길 수 있습니다.</li>
</ol>
<ul>
<li><strong>해결책:</strong> 락 획득 로직이 트랜잭션보다 바깥쪽(Facade 클래스 등)에서 실행되도록 설계해야 합니다.</li>
</ul>
<ol start="2">
<li><strong>WaitTime vs LeaseTime</strong>:</li>
</ol>
<ul>
<li><code>waitTime</code>: 이 시간 동안 락을 못 얻으면 <code>false</code>를 반환하고 포기합니다.</li>
<li><code>leaseTime</code>: 락을 얻은 후 이 시간이 지나면 자동으로 풀립니다. 로직 수행 시간보다 넉넉하게 잡아야 합니다.</li>
</ul>
<ol start="3">
<li><strong>AOP 활용</strong>:
매번 <code>try-finally</code>를 쓰기 번거롭다면, 커스텀 어노테이션(예: <code>@DistributedLock</code>)을 만들고 AOP로 락 획득/해제를 공통 처리하는 방식을 선호합니다.</li>
</ol>
<h1 id="transactional과-분산락을-안전하게-같이-사용하는-aop-구현-코드">@Transactional과 분산락을 안전하게 같이 사용하는 AOP 구현 코드</h1>
<p><code>@Transactional</code>과 분산락을 함께 사용할 때 가장 큰 함정은 <strong>데이터베이스 커밋 시점</strong>입니다.</p>
<p>트랜잭션이 끝나기 전에 락이 먼저 해제되면, DB에 데이터가 반영되기 직전의 찰나에 다른 스레드가 락을 채가서 변경 전 데이터를 읽는 문제가 발생합니다. 이를 해결하기 위해서는 <strong>락 획득 → 트랜잭션 시작 → 비즈니스 로직 → 트랜잭션 종료 → 락 해제</strong> 순서를 엄격히 지켜야 합니다.</p>
<hr>
<h2 id="1-커스텀-어노테이션-정의">1. 커스텀 어노테이션 정의</h2>
<p>먼저 락의 이름이나 타임아웃 설정을 파라미터로 받을 어노테이션을 만듭니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">DistributedLock</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">key</span><span class="p">();</span><span class="w"> </span><span class="c1">// 락의 식별자 (SpEL 지원용)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">waitTime</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">5L</span><span class="p">;</span><span class="w"> </span><span class="c1">// 락 획득 대기 시간 (초)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="nf">leaseTime</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">3L</span><span class="p">;</span><span class="w"> </span><span class="c1">// 락 점유 시간 (초)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="2-aop를-통한-락-비즈니스-로직-분리">2. AOP를 통한 락 비즈니스 로직 분리</h2>
<p>여기서 핵심은 <code>AopForTransaction</code>이라는 별도의 컴포넌트를 만들어 **새로운 트랜잭션(<code>REQUIRES_NEW</code>)**을 강제로 시작하는 것입니다. 이렇게 해야 부모 트랜잭션과 별개로 로직이 완료되자마자 DB 커밋이 일어나고, 그 이후에 비즈니스 로직 밖에서 락이 안전하게 해제됩니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Aspect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RequiredArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LockAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AopForTransaction</span><span class="w"> </span><span class="n">aopForTransaction</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&#34;@annotation(distributedLock)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">lock</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">,</span><span class="w"> </span><span class="n">DistributedLock</span><span class="w"> </span><span class="n">distributedLock</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 1. 락 키 파싱 (Method Signature 및 파라미터 추출)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CustomSpringELParser</span><span class="p">.</span><span class="na">getDynamicValue</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">getSignature</span><span class="p">().</span><span class="na">getName</span><span class="p">(),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">((</span><span class="n">MethodSignature</span><span class="p">)</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">getSignature</span><span class="p">()).</span><span class="na">getParameterNames</span><span class="p">(),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">getArgs</span><span class="p">(),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">distributedLock</span><span class="p">.</span><span class="na">key</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">RLock</span><span class="w"> </span><span class="n">rLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 2. 락 획득 시도</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rLock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">distributedLock</span><span class="p">.</span><span class="na">waitTime</span><span class="p">(),</span><span class="w"> </span><span class="n">distributedLock</span><span class="p">.</span><span class="na">leaseTime</span><span class="p">(),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">available</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// 3. 트랜잭션 분리 수행 (로직 실행 후 커밋까지 완료)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">aopForTransaction</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">joinPoint</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// 4. 로직이 완전히 커밋된 후 락 해제</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">rLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalMonitorStateException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;Redisson Lock Already Unlocked&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 별도의 트랜잭션을 보장하기 위한 컴포넌트
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AopForTransaction</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">propagation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Propagation</span><span class="p">.</span><span class="na">REQUIRES_NEW</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">proceed</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="3-실제-사용-예시">3. 실제 사용 예시</h2>
<p>이제 서비스 레이어에서 매우 깔끔하게 어노테이션 하나로 분산락을 적용할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@RequiredArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StockService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">StockRepository</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@DistributedLock</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;&#39;PRODUCT:&#39; + #productId&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">decreaseStock</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">quantity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Stock</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stockRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">productId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&#34;상품 없음&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">stock</span><span class="p">.</span><span class="na">decrease</span><span class="p">(</span><span class="n">quantity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 별도의 save() 호출 없이도 트랜잭션 종료 시 더티 체킹으로 커밋됨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="4-왜-이렇게-해야-하나요">4. 왜 이렇게 해야 하나요?</h2>
<ul>
<li><strong>트랜잭션 격리 수준 준수:</strong> <code>REQUIRES_NEW</code>를 통해 비즈니스 로직이 끝나는 즉시 DB에 변경 사항을 물리적으로 기록(Commit)합니다. 그 직후 <code>finally</code> 블록에서 락이 해제되므로, 다음 스레드가 락을 얻었을 때는 항상 최신화된 데이터를 보게 됩니다.</li>
<li><strong>유지보수성:</strong> 비즈니스 로직 코드 안에 <code>try-catch-finally</code>와 Redisson 코드가 뒤섞이지 않아 가독성이 매우 좋아집니다.</li>
</ul>
<blockquote>
<p><strong>주의:</strong> <code>REQUIRES_NEW</code>는 새로운 DB 커넥션을 점유하므로, 트래픽이 매우 높은 환경에서는 <strong>커넥션 풀(Connection Pool) 고갈</strong>에 유의해야 합니다.</p></blockquote>
<h1 id="msa에서의-분산락">MSA에서의 분산락</h1>
<p>서비스별로 DB가 분리된 <strong>MSA(Microservices Architecture)</strong> 환경이라면, 상황이 조금 더 복잡해지고 <strong>&ldquo;상관이 아주 많아집니다.&rdquo;</strong></p>
<p>단일 DB(Monolithic) 환경에서는 그나마 DB 트랜잭션으로 최후의 보루를 만들 수 있었지만, MSA에서는 <strong>데이터 일관성을 맞추는 난이도가 수직 상승</strong>하기 때문입니다.</p>
<hr>
<h2 id="1-msa에서-분산락이-필요한-이유">1. MSA에서 분산락이 필요한 이유</h2>
<p>MSA에서는 서비스 A가 DB A를, 서비스 B가 DB B를 가집니다. 이때 특정 비즈니스 로직이 두 서비스를 모두 거쳐야 한다면, <strong>전역적인 동기화</strong>가 필요합니다.</p>
<ul>
<li><strong>상황:</strong> &lsquo;주문 서비스&rsquo;에서 재고를 확인하고 &lsquo;결제 서비스&rsquo;에서 결제를 진행함.</li>
<li><strong>문제:</strong> 동일한 사용자가 아주 빠르게 결제 버튼을 두 번 누르면?</li>
<li>두 요청이 서로 다른 인스턴스에 도달합니다.</li>
<li>각 서비스는 자신의 DB만 보기 때문에, 상대방이 처리 중인지 알 수 없습니다.</li>
<li>결국 <strong>중복 결제</strong>나 <strong>재고 초과 차감</strong>이 발생할 수 있습니다.</li>
</ul>
<p>이때 Redis 같은 공통 저장소를 이용한 <strong>분산락</strong>은 여러 마이크로서비스 사이에서 &ldquo;지금 이 작업은 내가 하고 있으니 기다려!&ldquo;라고 말해주는 <strong>유일한 신호등</strong> 역할을 합니다.</p>
<hr>
<h2 id="2-msa에서-주의해야-할-트랜잭션의-한계">2. MSA에서 주의해야 할 &lsquo;트랜잭션의 한계&rsquo;</h2>
<p>앞서 설명한 <code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code> 방식은 <strong>단일 서비스 내의 DB</strong>에만 해당됩니다. MSA에서는 다음과 같은 문제가 발생합니다.</p>
<ol>
<li><strong>원자성(Atomicity) 파괴:</strong> 서비스 A의 DB 커밋은 성공했는데, 네트워크 문제로 서비스 B의 API 호출이 실패한다면? 락은 풀렸는데 데이터는 꼬이게 됩니다.</li>
<li><strong>커넥션 점유:</strong> 외부 API 호출(HTTP)은 DB 작업보다 훨씬 느립니다. 락을 잡은 채로 외부 API 응답을 기다리면, 전체 시스템의 처리량이 급격히 떨어집니다.</li>
</ol>
<hr>
<h2 id="3-msa-환경에서의-전략">3. MSA 환경에서의 전략</h2>
<p>MSA에서 분산락을 쓸 때는 단순히 코드 레벨의 락을 넘어 <strong>설계 패턴</strong>을 고민해야 합니다.</p>
<h3 id="a-멱등성idempotency-설계">A. 멱등성(Idempotency) 설계</h3>
<p>락에만 의존하지 말고, 여러 번 요청이 들어와도 결과가 같도록 설계하는 것이 우선입니다.</p>
<ul>
<li>예: 모든 요청에 <code>request_id</code>를 포함시켜, 이미 처리된 ID라면 무시합니다.</li>
</ul>
<h3 id="b-saga-패턴-활용">B. SAGA 패턴 활용</h3>
<p>분산락으로 짧은 찰나의 동시성을 제어하고, 긴 비즈니스 흐름(주문-&gt;결제-&gt;배송)의 데이터 일관성은 <strong>Saga 패턴</strong>(보상 트랜잭션)을 통해 해결합니다.</p>
<h3 id="c-락의-범위-최소화">C. 락의 범위 최소화</h3>
<p>외부 API 호출을 락 내부에서 수행하지 마세요.</p>
<ol>
<li>락 획득</li>
<li><strong>내부 DB 로직 처리 (최단 시간)</strong></li>
<li>락 해제</li>
<li><strong>외부 서비스 호출 (락 해제 후 진행)</strong></li>
</ol>
<hr>
<h2 id="4-결론-msa에서-분산락은-필수인가">4. 결론: MSA에서 분산락은 &lsquo;필수&rsquo;인가?</h2>
<ul>
<li><strong>공유 자원이 있다면 필수:</strong> 여러 서비스가 동일한 Redis나 특정 공용 자원을 바라본다면 반드시 필요합니다.</li>
<li><strong>사용자 진입점 제어:</strong> 보통 MSA의 입구인 <strong>API Gateway</strong>나 <strong>최상위 오케스트레이터 서비스</strong>에서 분산락을 걸어 중복 진입을 막는 용도로 가장 많이 사용됩니다.</li>
</ul>
<blockquote>
<p><strong>한 줄 요약:</strong> MSA에서는 DB가 찢어져 있어 서로를 모르기 때문에, 오히려 Redis 같은 제3의 중재자를 통한 분산락의 역할이 훨씬 더 중요해집니다.</p></blockquote>
</article>
              </div>

              
            </div>
          </div>
        </div>
      </div>

      <div class="pagination-nav">
        <div class="pagination-button next-post">
          
        </div>
        
        <div class="pagination-button previous-post">
          
          <a class="pagination-link link-reverse" href="https://pink-spider.github.io/post/infra/redis/redis_streams/">Redis pub/sub 과 streams&nbsp;</a><div> »</div>
          
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://pink-spider.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://pink-spider.github.io/css/toc.css' />

<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://pink-spider.github.io/css/gitalk.css'>
<script src='https://pink-spider.github.io/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    accessToken: '',
    repo: 'pink-spider.github.io',
    owner: 'pink-spider',
    admin: ['pink-spider'],
    id: eval("location.pathname"), 
    distractionFreeMode: false 
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"
  >
    <ul
      class="list-style-none d-flex flex-wrap col-12 flex-justify-center mb-2 mb-lg-0"
    >
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>
</div>

</body>

<script type="application/javascript" src="https://pink-spider.github.io/js/github-style.js"></script>

<script src="https://pink-spider.github.io/js/mark.es6.min.js"></script>


<script type="text/javascript">

  const host = window.location.host;
  const keyword = localStorage.getItem('keyword');
  localStorage.removeItem('keyword');

  if (keyword) {
    const markInstance = new Mark(document.body);
    markInstance.unmark({
      done: function() {
        markInstance.mark(keyword);
      }
    });
  }

  const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-primary');
  const mutedColor = getComputedStyle(document.documentElement).getPropertyValue('--color-fg-muted');
  const hoverColor = '#216EEB';

  let originalStyle;
  let svgOriginalStyle;
  let titleOriginalStyle;

  const onMouseOver = (node) => {
    originalStyle = Object.assign({}, node.style);
    node.style.backgroundColor = hoverColor;

    const child = node.querySelector('.js-jump');
    child.classList.remove('d-on-nav-focus');

    const title = node.querySelector('.title');
    if (title && primaryColor === ' #fff') {
      titleOriginalStyle = title.style;
      title.style.color = '#fff';
    }

    const svg = node.querySelector('.octicon');
    if (svg) {
      svgOriginalStyle = svg.style;
      svg.style.color = '#fff';
    }
  }

  const onMouseLeave = (node) => {
    node.style = originalStyle;
    const child = node.querySelector('.js-jump');
    child.classList.add('d-on-nav-focus');

    const title = node.querySelector('.title');
    title.style = titleOriginalStyle;

    const svg = node.querySelector('.octicon');
    svg.style = svgOriginalStyle;
  }

  const createSearchItem = (title, link, index) => {
    return `
    <li class="color-bg-primary search-item d-flex flex-justify-start flex-items-center p-0 f5 navigation-item js-navigation-item js-jump-to-scoped-search"
        role="option" aria-selected="false" tabindex="${index}">
        <a onmouseover="onMouseOver(this)" onmouseleave="onMouseLeave(this)"
          class="no-underline d-flex flex-auto flex-items-center jump-to-suggestions-path js-jump-to-suggestion-path js-navigation-open p-2"
          href="${link}" data-item-type="scoped_search">
          <div class="jump-to-octicon js-jump-to-octicon flex-shrink-0 mr-2 text-center ">
            <svg title="Repository" aria-label="Repository" role="img" height="16" viewBox="0 0 16 16"
              version="1.1" width="16" data-view-component="true"
              class="octicon octicon-repo js-jump-to-octicon-repo  flex-shrink-0">
              <path fill-rule="evenodd"
                d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z">
              </path>
            </svg>
          </div>    

          <div
            class="title jump-to-suggestion-name js-jump-to-suggestion-name flex-auto overflow-hidden text-left no-wrap css-truncate css-truncate-target">
            ${title}
          </div>

          <div aria-hidden="true" style="color: var(--color-fg-muted);"
            class="color-bg-primary js-jump border rounded-2 flex-shrink-0 color-bg-subtle px-1 ml-1 f6 d-on-nav-focus js-jump-to-badge-jump">
            Jump to
            <span class="d-inline-block ml-1 v-align-middle">↵</span>
          </div>
        </a>
      </li>
    `
  }

  const createGoogleSearchItem = (keyword) => {
    return `
    <li class="color-bg-primary search-item d-flex flex-justify-start flex-items-center p-0 f5 navigation-item js-navigation-item js-jump-to-scoped-search"
        role="option" aria-selected="false" tabindex="0">
        <a onmouseover="onMouseOver(this)" onmouseleave="onMouseLeave(this)"
          class="no-underline d-flex flex-auto flex-items-center jump-to-suggestions-path js-jump-to-suggestion-path js-navigation-open p-2"
          href="https://www.google.com/search?q=${keyword}" target="_blank" data-item-type="scoped_search">
          <div class="jump-to-octicon js-jump-to-octicon flex-shrink-0 mr-2 text-center ">
            <svg title="Search" aria-label="Search" role="img" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" class="octicon octicon-search js-jump-to-octicon-search flex-shrink-0">
                <path fill-rule="evenodd" d="M11.5 7a4.499 4.499 0 11-8.998 0A4.499 4.499 0 0111.5 7zm-.82 4.74a6 6 0 111.06-1.06l3.04 3.04a.75.75 0 11-1.06 1.06l-3.04-3.04z"></path>
            </svg>
          </div>    

          <div
            class="title jump-to-suggestion-name js-jump-to-suggestion-name flex-auto overflow-hidden text-left no-wrap css-truncate css-truncate-target">
            ${keyword}
          </div>

          <div aria-hidden="true" style="color: var(--color-fg-muted);"
            class="color-bg-primary js-jump border rounded-2 flex-shrink-0 color-bg-subtle px-1 ml-1 f6 d-on-nav-focus js-jump-to-badge-jump">
            Google search
            <span class="d-inline-block ml-1 v-align-middle">↵</span>
          </div>
        </a>
      </li>
    `
  }

  const stripHtml = (html) => {
    let tmp = document.createElement('div');
    tmp.innerHTML = html;

    
    const styles = tmp.getElementsByTagName('style');
    while(styles[0]) {
      styles[0].parentNode.removeChild(styles[0]);
    }

    
    const scripts = tmp.getElementsByTagName('script');
    while(scripts[0]) {
      scripts[0].parentNode.removeChild(scripts[0]);
    }
    
    return tmp.textContent || tmp.innerText || "";
  }

  const inputDom = document.querySelector(".Header-search-input");
  const resultDom = document.getElementById('jump-to-results');
  let debounceTimer;
  let parser;
  let xmlDoc;

  const search = (_keyword) => {

    resultDom.innerHTML = '';

    const keyword = _keyword;

    if (!keyword) return;

    const progressDom = document.getElementById('search-progress');
    if (progressDom && progressDom.classList.contains('d-none')) {
      progressDom.classList.remove('d-none');
    }

    localStorage.setItem('keyword', keyword);
    fetch(`${host.indexOf('localhost') > -1 ? 'http://' : 'https://'}${host}/index.xml`).then(resp => resp.text()).then(async (res) => {
      parser = new DOMParser();
      xmlDoc = parser.parseFromString(res, 'text/xml');
      const linkResult = xmlDoc.getElementsByTagName('link');
      const titleResult = xmlDoc.getElementsByTagName('title');
      const arr = [];

      const matched = [];
      await (async function searchLink() {
        for (let i = 0; i < linkResult.length; i++) {
          await fetch(linkResult[i].textContent).then(resp => resp.text().then(res => {
            const pureText = stripHtml(res);
            if (pureText.indexOf(keyword) >= 0) {
              matched.push(i);
            }
          }))
        }
      })();

      const googleSearchItem = createGoogleSearchItem(keyword);
      const node= document.createRange().createContextualFragment(googleSearchItem);
      resultDom.appendChild(node);

      matched.map((itemIndex, index) => {
        const r = createSearchItem(titleResult[itemIndex].textContent, linkResult[itemIndex].textContent, index + 1);
        const node = document.createRange().createContextualFragment(r);
        resultDom.appendChild(node);
      });

      if (progressDom && !progressDom.classList.contains('d-none')) {
        progressDom.classList.add('d-none');
      }
    });
  }

  const debounce = (callback, time) => {
    window.clearTimeout(debounceTimer);
    debounceTimer = window.setTimeout(callback, time);
  };

  ['focus', 'input'].forEach(event => {
    inputDom.addEventListener(event, (e) => {
      debounce(() => search(e.target.value), 500);
    }, false);
  });

  inputDom.addEventListener('blur', () => {
    setTimeout(() => {
      resultDom.innerHTML = '';
    }, 100);
  });

</script>






</html>